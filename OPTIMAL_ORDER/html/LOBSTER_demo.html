
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>HFT Limit order book data preprocessing and visualization</title><meta name="generator" content="MATLAB 8.1"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2013-07-17"><meta name="DC.source" content="LOBSTER_demo.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, tt, code { font-size:12px; }
pre { margin:0px 0px 20px; }
pre.error { color:red; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>HFT Limit order book data preprocessing and visualization</h1><!--introduction--><p>using LOBSTER from Berlin University <a href="http://LOBSTER.wiwi.hu-berlin.de">http://LOBSTER.wiwi.hu-berlin.de</a> Data used: AMZN - 2012-June-21 - 10 Levels ----------------------------------------------------------</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Set up the Basics</a></li><li><a href="#2">Load Messsage File</a></li><li><a href="#3">Data Preparation - Message File</a></li><li><a href="#4">Set Bounds for Intraday Intervals</a></li><li><a href="#5">Sampling - Number of Executions and Trade Volume by Interval</a></li><li><a href="#6">Plot - Number of Executions and Trade Volume by Interval</a></li><li><a href="#7">Load Orderbook File</a></li><li><a href="#8">Data Preparation - Orderbook File</a></li><li><a href="#9">Plot - Snapshot of the Limit Order Book</a></li><li><a href="#10">Plot - Relative Depth in the Limit Order Book</a></li><li><a href="#11">Plot bid/ask spread intraday evolution</a></li><li><a href="#12">Plot - Intraday Evolution of Depth</a></li><li><a href="#13">Preprocessing our VAR time serie</a></li><li><a href="#14">Concatenating relevant values</a></li><li><a href="#15">Saving as a .mat file</a></li></ul></div><h2>Set up the Basics<a name="1"></a></h2><p>Clear system</p><pre class="codeinput">clear <span class="string">all</span>;
clc;
<span class="comment">% Stock name</span>
ticker      = <span class="string">'AMZN'</span>;
<span class="comment">% Levels</span>
lvl         = 10;
<span class="comment">% File names</span>
nameBook    = <span class="string">'AMZN_2012-06-21_34200000_57600000_orderbook_10.csv'</span>;
nameMess    = <span class="string">'AMZN_2012-06-21_34200000_57600000_message_10.csv'</span>;
<span class="comment">% Date of files</span>
demoDate    = [2012,6,21];      <span class="comment">% year, month, day</span>
</pre><h2>Load Messsage File<a name="2"></a></h2><p>Load data</p><pre class="codeinput">mess = dlmread(nameMess);
<span class="comment">% Message file information:</span>
<span class="comment">% ----------------------------------------------------------</span>
<span class="comment">%</span>
<span class="comment">%   - Dimension:    (NumberEvents x 6)</span>
<span class="comment">%</span>
<span class="comment">%   - Structure:    Each row:</span>
<span class="comment">%                   Time stamp (sec after midnight with decimal</span>
<span class="comment">%                   precision of at least milliseconds and</span>
<span class="comment">%                   up to nanoseconds depending on the period),</span>
<span class="comment">%                   Event type, Order ID, Size (# of shares),</span>
<span class="comment">%                   Price, Direction</span>
<span class="comment">%</span>
<span class="comment">%                   Event types:</span>
<span class="comment">%                       - '1'   Submission new limit order</span>
<span class="comment">%                       - '2'   Cancellation (partial)</span>
<span class="comment">%                       - '3'   Deletion (total order)</span>
<span class="comment">%                       - '4'   Execution against visible</span>
<span class="comment">%                               liquidity</span>
<span class="comment">%                       - '5'   Execution against hidden</span>
<span class="comment">%                               liquidity</span>
<span class="comment">%                       - '7'   Trading Halt (Detailed</span>
<span class="comment">%                               information below)</span>
<span class="comment">%</span>
<span class="comment">%                   Direction:</span>
<span class="comment">%                       - '-1'  Sell limit order</span>
<span class="comment">%                       - '-2'  Buy limit order</span>
<span class="comment">%                       - NOTE: Execution of a sell (buy)</span>
<span class="comment">%                               limit order corresponds to</span>
<span class="comment">%                               a buyer-(seller-) initiated</span>
<span class="comment">%                               trade, i.e. a BUY (SELL) trade.</span>
<span class="comment">%</span>
<span class="comment">% ----------------------------------------------------------</span>
</pre><h2>Data Preparation - Message File<a name="3"></a></h2><p>Remove observations outside the official trading hours ---------------------------------------------------------- Trading hours (start &amp; end)</p><pre class="codeinput">startTrad   = 9.5*60*60;       <span class="comment">% 9:30:00 in sec</span>
<span class="comment">% after midnight</span>
endTrad     = 16*60*60;        <span class="comment">% 16:00:00 in sec</span>
<span class="comment">% after midnight</span>
<span class="comment">% Get index of observations</span>
timeIdx = mess(:,1) &gt;= startTrad &amp; mess(:,1) &lt;= endTrad;
mess = mess(timeIdx,:);
<span class="comment">% Note: As the rows of the message and orderbook file</span>
<span class="comment">%       correspond to each other, the time index of</span>
<span class="comment">%       the message file can also be used to 'cut'</span>
<span class="comment">%       the orderbook file.</span>

<span class="comment">% Check for trading halts</span>
<span class="comment">% ----------------------------------------------------------</span>
tradeHaltIdx = find(mess(:,2) == 7);
<span class="keyword">if</span> ~isempty(tradeHaltIdx)
    disp([<span class="string">'Data contains trading halt! Trading halt, '</span> <span class="keyword">...</span>
        <span class="string">'quoting resume, and resume of trading indices in tradeHaltIdx'</span>]);
<span class="keyword">else</span>
    disp(<span class="string">'No trading halts detected.'</span>);
<span class="keyword">end</span>
<span class="comment">%       When trading is halted, a message of type '7' is written into the</span>
<span class="comment">% 		message file. The corresponding price and trade direction are set</span>
<span class="comment">% 		to '-1' and all other properties are set to '0'.</span>
<span class="comment">% 		Should quoting be allowed during the halt, another message</span>
<span class="comment">% 		of type '7' with price '0' is added. Again the trade direction</span>
<span class="comment">% 		is set to '-1' and all other fields are set to '0'.</span>
<span class="comment">% 		The resuming of trading is indicated by a message of type '7'</span>
<span class="comment">% 		and price '1' (Trade direction '-1' and all other entries '0').</span>
<span class="comment">% 		For messages of type '7' the corresponding orderbook rows contains</span>
<span class="comment">% 		a duplication of the preceding order book state.</span>
<span class="comment">% 		The reason for the trading halt is not included in the output.</span>
<span class="comment">%</span>
<span class="comment">% 			Example: Stylized trading halt messages in 'message' file.</span>
<span class="comment">%</span>
<span class="comment">% 			Halt: 				36023	| 7 | 0 | 0 | -1 | -1</span>
<span class="comment">% 											...</span>
<span class="comment">% 			Quoting: 			36323 	| 7 | 0 | 0 | 0  | -1</span>
<span class="comment">% 											...</span>
<span class="comment">% 			Resume Trading:		36723   | 7 | 0 | 0 | 1  | -1</span>
<span class="comment">% 											...</span>
<span class="comment">% 			The vertical bars indicate the different columns in the</span>
<span class="comment">% 			message file.</span>
</pre><pre class="codeoutput">No trading halts detected.
</pre><h2>Set Bounds for Intraday Intervals<a name="4"></a></h2><p>Define interval length</p><pre class="codeinput">freq = 5*60;   <span class="comment">% Interval length in sec</span>
<span class="comment">% Set interval bounds</span>
bounds = (startTrad:freq:endTrad)';
<span class="comment">% Number of intervals</span>
bl = size(bounds,1);
<span class="comment">% Indices for intervals</span>
boundIdx = zeros(bl,1);
k1 = 1;
<span class="keyword">for</span> k2 = 1:size(mess,1)
    <span class="keyword">if</span> mess(k2,1) &gt;= bounds(k1)
        boundIdx(k1,1) = k2;
        k1 = k1+1;
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">% Get index of observations relevant for the bound</span>
boundIdx(1:end-1) = boundIdx(1:end-1)-1;
boundIdx(end) = length(mess);
<span class="comment">% Note:</span>
<span class="comment">%   -   This is a rather rough procedure for obtaining</span>
<span class="comment">%       interval bounds! Be careful!</span>
<span class="comment">%   -   boundIdx(1) = 0 due to loop characteristics below.</span>
</pre><h2>Sampling - Number of Executions and Trade Volume by Interval<a name="5"></a></h2><p>Note: Difference between trades and executions</p><pre>     The LOBSTER output records limit order executions
     and not what one might intuitively consider trades.</pre><pre>     Imagine a volume of 1000 is posted at the best ask
     price. Further, an incoming market buy order of
     volume 1000 is executed against the quote.</pre><pre>     The LOBSTER output of this trade depends on the
     composition of the volume at the best ask price.
     Take the following two scenarios with the best ask
     volume consisting of ...
     (a) 1 sell limit order with volume 1000
     (b) 5 sell limit orders with volume 200 each
         (ordered according to time of submission)</pre><pre>     The LOBSTER output for case ...
     (a) shows one execution of volume 1000. If the
         incoming market order is matched with one
         standing limit order, execution and trade
         coincide.
     (b) shows 5 executions of volume 200 each with the
         same time stamp. The incoming order is matched
         with 5 standing limit orders and triggers 5
         executions.</pre><pre>     Bottom line:
     LOBSTER records the exact limit orders against
     which incoming market orders are executed. What
     might be called 'economic' trade size has to be
     inferred from the executions.</pre><pre class="codeinput"><span class="comment">% Collection matrix</span>
tradesInfo = zeros(bl-1,4);
<span class="comment">% Note: Number visible executions, volume visible</span>
<span class="comment">%       trades, number hidden executions,</span>
<span class="comment">%       volume hidden trades</span>
<span class="keyword">for</span> k1 = 1:(bl-1)

    <span class="comment">% Get intraday mess window</span>
    temp	= mess(boundIdx(k1)+1:boundIdx(k1+1),[2,4]);
    <span class="comment">% Visible</span>
    tempVis = temp(temp(:,1)==4,2);
    <span class="comment">% Hidden</span>
    tempHid = temp(temp(:,1)==5,2);
    <span class="comment">% Collect information</span>
    tradesInfo(k1,:) = [ size(tempVis,1), sum(tempVis), <span class="keyword">...</span>
        size(tempHid,1), sum(tempHid)];
    clear <span class="string">temp</span> <span class="string">tempVis</span> <span class="string">tempHid</span>;
<span class="keyword">end</span>
</pre><h2>Plot - Number of Executions and Trade Volume by Interval<a name="6"></a></h2><p>Plot number of executions</p><pre class="codeinput">figure(<span class="string">'color'</span>,<span class="string">'white'</span>,<span class="string">'Name'</span>,<span class="string">'Number of Executions'</span>);
<span class="comment">% Visible ...</span>
bar(tradesInfo(:,1),<span class="string">'red'</span>);
title({[ticker <span class="string">' // '</span> <span class="keyword">...</span>
    datestr(datenum(demoDate),<span class="string">'yyyy-mmm-dd'</span>)] <span class="keyword">...</span>
    [<span class="string">'Number of Executions per '</span> <span class="keyword">...</span>
    num2str(freq./60) <span class="string">' min Interval '</span>]});
xlabel(<span class="string">'Interval'</span>);
ylabel([<span class="string">'Number of Executions'</span>]);
hold <span class="string">on</span>
<span class="comment">% Hidden ...</span>
bar(-tradesInfo(:,3),<span class="string">'blue'</span>);
<span class="comment">% Legend</span>
legend(<span class="string">'Visible'</span>,<span class="string">'Hidden'</span>,<span class="string">'Location'</span>,<span class="string">'North'</span>);
hold <span class="string">off</span>;

<span class="comment">% Plot volume of trades</span>
figure(<span class="string">'color'</span>,<span class="string">'white'</span>,<span class="string">'Name'</span>,<span class="string">'Volume of Trades'</span>);
<span class="comment">% Visible ...</span>
bar(tradesInfo(:,2)./100,<span class="string">'red'</span>);
title({[ticker <span class="string">' // '</span> <span class="keyword">...</span>
    datestr(datenum(demoDate),<span class="string">'yyyy-mmm-dd'</span>)] <span class="keyword">...</span>
    [<span class="string">'Volume of Trades per '</span> <span class="keyword">...</span>
    num2str(freq./60) <span class="string">' min Interval '</span>]});
xlabel(<span class="string">'Interval'</span>);
ylabel([<span class="string">'Volume of Trades (x100 Shares)'</span>]);
hold <span class="string">on</span>
<span class="comment">% Hidden ...</span>
bar(-tradesInfo(:,4)./100,<span class="string">'blue'</span>);
<span class="comment">% Legend</span>
legend(<span class="string">'Visible'</span>,<span class="string">'Hidden'</span>,<span class="string">'Location'</span>,<span class="string">'North'</span>);
hold <span class="string">off</span>;
<span class="comment">% Note: When considering cumulative volume in an interval</span>
<span class="comment">%       the distinction between trades and executions is</span>
<span class="comment">%       not necessary. However, when, for example,</span>
<span class="comment">%       investigating average trade size one can not rely</span>
<span class="comment">%       on the computations performed here. In this case</span>
<span class="comment">%       the executions first have to be aggregated to</span>
<span class="comment">%       trades.</span>
</pre><img vspace="5" hspace="5" src="LOBSTER_demo_01.png" alt=""> <img vspace="5" hspace="5" src="LOBSTER_demo_02.png" alt=""> <h2>Load Orderbook File<a name="7"></a></h2><p>Load data</p><pre class="codeinput">book = dlmread(nameBook);
<span class="comment">% Note: The file contains more than 250 000 entries. It</span>
<span class="comment">%       takes a few seconds to load.</span>

<span class="comment">% Orderbook file information:</span>
<span class="comment">% ----------------------------------------------------------</span>
<span class="comment">%</span>
<span class="comment">%   - Dimension:    (NumberEvents x (NumberLevels*4+1))</span>
<span class="comment">%</span>
<span class="comment">%   - Structure:    Each row:</span>
<span class="comment">%                   Ask price 1, Ask volume 1, Bid price 1,</span>
<span class="comment">%                   Bid volume 1, Ask price 2, Ask volume 2,</span>
<span class="comment">%                   Bid price 2, Bid volume 2, ...</span>
<span class="comment">%</span>
<span class="comment">%   - Note:         Unoccupied bid (ask) price levels are</span>
<span class="comment">%                   set to -999999999 (99999999) with volume 0</span>
<span class="comment">%</span>
<span class="comment">% ----------------------------------------------------------</span>
</pre><h2>Data Preparation - Orderbook File<a name="8"></a></h2><pre class="codeinput"><span class="comment">% Remove observations outside the official trading hours</span>
<span class="comment">% ----------------------------------------------------------</span>
<span class="comment">% Remove observations outside time window</span>
book = book(timeIdx,:);
<span class="comment">% Convert prices into dollars</span>
<span class="comment">% ----------------------------------------------------------</span>
book(:,[1:2:(4*lvl)]) = book(:,[1:2:(4*lvl)])./10000;
<span class="comment">% Note: LOBSTER stores prices in dollar price times 10000</span>
</pre><h2>Plot - Snapshot of the Limit Order Book<a name="9"></a></h2><p>Select index of event to be displayed</p><pre class="codeinput">eventIdx = unidrnd(length(book));
<span class="comment">% Note: Pick a random row/event from the order book</span>

<span class="comment">% Postions of variables in the book</span>
askPricePos = 1:4:(lvl*4);
askVolPos   = askPricePos+1;
bidPricePos = askPricePos+2;
bidVolPos   = bidPricePos+1;
vol         = 2:2:(lvl*4);

<span class="comment">% Plot limits ...</span>
<span class="comment">% Price</span>
maxPrice =  book(eventIdx,askPricePos(lvl)) + 0.01;
minPrice =  book(eventIdx,bidPricePos(lvl)) - 0.01;

<span class="comment">% Volume</span>
maxVol =  max(book(eventIdx,vol));

<span class="comment">% Mid quote</span>
mid = 0.5*(sum(book(eventIdx,[1,3]),2));

<span class="comment">% Plot</span>
figure(<span class="string">'color'</span>,<span class="string">'white'</span>,<span class="string">'Name'</span>,<span class="string">'Limit Order Book - Snapshot'</span>);
<span class="comment">% Ask side</span>
barh(book(eventIdx,askPricePos)', <span class="keyword">...</span>
    book(eventIdx,askVolPos)',<span class="string">'green'</span>);
title({[ticker <span class="string">' // '</span> <span class="keyword">...</span>
    datestr(datenum(demoDate),<span class="string">'yyyy-mmm-dd'</span>)] <span class="keyword">...</span>
    [<span class="string">' LOB Snapshot - Time: '</span> <span class="keyword">...</span>
    num2str(mess(eventIdx,1)) <span class="string">' sec'</span>]});
xlabel(<span class="string">'Volume'</span>);
ylabel(<span class="string">'Price ($)'</span>);
ylim([minPrice,maxPrice]);
xlim([0,maxVol]);
hold <span class="string">on</span>;
<span class="comment">% Bid side</span>
barh(book(eventIdx,bidPricePos)', <span class="keyword">...</span>
    book(eventIdx,bidVolPos)',<span class="string">'red'</span>);
<span class="comment">% Mid</span>
plot(50,mid,<span class="string">'&lt;k'</span>,<span class="string">'LineWidth'</span>, 2);
<span class="comment">% Legend</span>
legend(<span class="string">'Ask'</span>,<span class="string">'Bid'</span>,<span class="string">'Mid'</span>,<span class="string">'Location'</span>,<span class="string">'East'</span>);
hold <span class="string">off</span>
</pre><img vspace="5" hspace="5" src="LOBSTER_demo_03.png" alt=""> <h2>Plot - Relative Depth in the Limit Order Book<a name="10"></a></h2><p>Relative volume ... Ask</p><pre class="codeinput">bookVolAsk = cumsum(book(eventIdx,askVolPos),2);
bookVolAsk = bookVolAsk./bookVolAsk(end);

<span class="comment">% Bid</span>
bookVolBid = cumsum(book(eventIdx,bidVolPos),2);
bookVolBid = bookVolBid./bookVolBid(end);

<span class="comment">% Plot</span>
figure(<span class="string">'color'</span>,<span class="string">'white'</span>,<span class="string">'Name'</span>,<span class="keyword">...</span>
    <span class="string">'Limit Order Book - Relative Depth'</span>);
<span class="comment">% Ask side</span>
stairs((1:lvl)',bookVolAsk',<span class="string">'LineWidth'</span>,1.5,<span class="string">'Color'</span>,<span class="string">'g'</span>);
title({[ticker <span class="string">' // '</span> <span class="keyword">...</span>
    datestr(datenum(demoDate),<span class="string">'yyyy-mmm-dd'</span>)] <span class="keyword">...</span>
    [<span class="string">'LOB Relative Depth - Time: '</span> <span class="keyword">...</span>
    num2str(mess(eventIdx,1)) <span class="string">' sec'</span>]});
ylabel(<span class="string">'% of Volume'</span>);
xlabel(<span class="string">'Level'</span>);
xlim([0,lvl]);
set(gca,<span class="string">'YTickLabel'</span>, <span class="keyword">...</span>
    {<span class="string">'1'</span>,<span class="string">'0,8'</span>,<span class="string">'0.6'</span>,<span class="string">'0,4'</span>,<span class="string">'0,2'</span>,<span class="string">''</span>,<span class="string">'0,2'</span>, <span class="keyword">...</span>
    <span class="string">'0,4'</span>,<span class="string">'0,6'</span>,<span class="string">'0,8'</span>,<span class="string">'1'</span>},<span class="string">'YTick'</span>, <span class="keyword">...</span>
    [-1 -0.8 -0.6 -0.4 -0.2 0 0.2 0.4 0.6 0.8 1]);
hold <span class="string">on</span>

<span class="comment">% Bid side</span>
stairs((1:lvl)',-1*bookVolBid', <span class="keyword">...</span>
    <span class="string">'LineWidth'</span>,1.5,<span class="string">'Color'</span>,<span class="string">'r'</span>);

<span class="comment">% Legend</span>
legend(<span class="string">'Ask'</span>,<span class="string">'Bid'</span>,<span class="string">'Location'</span>,<span class="string">'SouthWest'</span>);

hold <span class="string">off</span>
</pre><img vspace="5" hspace="5" src="LOBSTER_demo_04.png" alt=""> <h2>Plot bid/ask spread intraday evolution<a name="11"></a></h2><pre class="codeinput">plot(mess(:,1)./(60*60), <span class="keyword">...</span>
    book(:,[1,3]));
title({[ticker <span class="string">' // '</span> <span class="keyword">...</span>
    datestr(datenum(demoDate),<span class="string">'yyyy-mmm-dd'</span>)] <span class="keyword">...</span>
    [<span class="string">'Intraday Evolution of Bid/Ask spread'</span>]});
axis <span class="string">tight</span>;
</pre><img vspace="5" hspace="5" src="LOBSTER_demo_05.png" alt=""> <h2>Plot - Intraday Evolution of Depth<a name="12"></a></h2><pre class="codeinput"><span class="comment">% Display only the first 3 levels</span>
maxLvl = 3;
<span class="comment">% Postion of volumes in the book</span>
askVolPos = 2:4:maxLvl*4;
<span class="comment">% Depth</span>
bookVolAsk  = cumsum(book(:,askVolPos)./100,2);
bookVolBid  = cumsum(book(:,askVolPos+2)./100,2);
<span class="comment">% Max depth</span>
maxVol = max(max(bookVolAsk(:,end)),max(bookVolBid(:,end)));
maxVol = floor(maxVol*1.1/10)*10;
<span class="comment">% LegendStr</span>
legendStr = [repmat(<span class="string">'Ask'</span>,maxLvl,1),blanks(maxLvl)',<span class="keyword">...</span>
    num2str((1:maxLvl)'); repmat(<span class="string">'Bid'</span>,maxLvl,1), <span class="keyword">...</span>
    blanks(maxLvl)',num2str((1:maxLvl)')];
<span class="comment">% Plot</span>
figure(<span class="string">'color'</span>,<span class="string">'white'</span>,<span class="string">'Name'</span>, <span class="keyword">...</span>
    <span class="string">'Limit Order Book - Intraday Depth'</span>);
plot(mess(:,1)./(60*60), <span class="keyword">...</span>
    [bookVolAsk, -1*bookVolBid]);
title({[ticker <span class="string">' // '</span> <span class="keyword">...</span>
    datestr(datenum(demoDate),<span class="string">'yyyy-mmm-dd'</span>)] <span class="keyword">...</span>
    [<span class="string">'Intraday Evolution of Depth'</span>]});
ylim([-maxVol,maxVol]);
xlim([9,16.5]);
xlabel(<span class="string">'Time'</span>);
ylabel([<span class="string">'Bid '</span> blanks(12) <span class="keyword">...</span>
    <span class="string">' Number of Shares (x100) '</span> blanks(12) <span class="string">' Ask '</span>]);
<span class="comment">% Tick labels</span>
set(gca,<span class="string">'YTickLabel'</span>,{<span class="string">' '</span>, num2str(maxVol/2), 0, <span class="keyword">...</span>
    num2str(maxVol/2), <span class="string">' '</span>},<span class="string">'YTick'</span>, <span class="keyword">...</span>
    [-maxVol -maxVol/2 0 maxVol/2 maxVol]);
<span class="comment">% Legend</span>
legend(legendStr,<span class="string">'Location'</span>,<span class="string">'SouthOutside'</span>, <span class="keyword">...</span>
    <span class="string">'Orientation'</span>, <span class="string">'horizontal'</span>);
</pre><img vspace="5" hspace="5" src="LOBSTER_demo_06.png" alt=""> <h2>Preprocessing our VAR time serie<a name="13"></a></h2><p>execution business times</p><pre class="codeinput">execution_id = (mess(:,2) == 4) | (mess(:,2)==5);
<span class="comment">% locating buyer initiated trade (execution of a sell limit order)</span>
all_buy_exec=execution_id&amp;mess(:,6)==-1;
all_buy_exec=double(all_buy_exec);
buy_initiated=all_buy_exec;
buy_initiated(2:end)=all_buy_exec(2:end)-all_buy_exec(1:end-1);
buy_initiated=max(buy_initiated,0);
<span class="comment">% locating seller initiated trade  (execution of a buy limit order)</span>
all_sell_exec=execution_id&amp;mess(:,6) ==1;
all_sell_exec=double(all_sell_exec);
sell_initiated=all_sell_exec;
sell_initiated(2:end)=all_sell_exec(2:end)-all_sell_exec(1:end-1);
sell_initiated=max(sell_initiated,0);
<span class="comment">% consecutive executions of sell limit order stem from a same market order</span>
<span class="comment">% executing over multiple limit orders</span>
</pre><h2>Concatenating relevant values<a name="14"></a></h2><p>Display only the first 3 levels</p><pre class="codeinput">maxLvl = 3;
<span class="comment">% Postion of ask volumes in the book for the first 3 levels</span>
askVolPos = 2:4:maxLvl*4;
<span class="comment">% log best ask, log best bid, log best ask volume, log best bid volume,</span>
Y=[log(book(:,1)),log(book(:,3)), log(book(:,askVolPos)),log(book(:,askVolPos+2)),buy_initiated,sell_initiated];
timestamps=mess(:,1);
</pre><h2>Saving as a .mat file<a name="15"></a></h2><pre class="codeinput">save(<span class="string">'preprocessed_time_series.mat'</span>,<span class="string">'Y'</span>,<span class="string">'timestamps'</span>);
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2013a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% HFT Limit order book data preprocessing and visualization
% using LOBSTER from Berlin University http://LOBSTER.wiwi.hu-berlin.de
% Data used: AMZN - 2012-June-21 - 10 Levels
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

%% Set up the Basics
% Clear system
clear all;
clc;
% Stock name
ticker      = 'AMZN';
% Levels
lvl         = 10;
% File names
nameBook    = 'AMZN_2012-06-21_34200000_57600000_orderbook_10.csv';
nameMess    = 'AMZN_2012-06-21_34200000_57600000_message_10.csv';
% Date of files
demoDate    = [2012,6,21];      % year, month, day

%% Load Messsage File
% Load data
mess = dlmread(nameMess);
% Message file information:
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%
%   - Dimension:    (NumberEvents x 6)
%
%   - Structure:    Each row:
%                   Time stamp (sec after midnight with decimal
%                   precision of at least milliseconds and
%                   up to nanoseconds depending on the period),
%                   Event type, Order ID, Size (# of shares),
%                   Price, Direction
%
%                   Event types:
%                       - '1'   Submission new limit order
%                       - '2'   Cancellation (partial)
%                       - '3'   Deletion (total order)
%                       - '4'   Execution against visible
%                               liquidity
%                       - '5'   Execution against hidden
%                               liquidity
%                       - '7'   Trading Halt (Detailed
%                               information below)
%
%                   Direction:
%                       - '-1'  Sell limit order
%                       - '-2'  Buy limit order
%                       - NOTE: Execution of a sell (buy)
%                               limit order corresponds to
%                               a buyer-(seller-) initiated
%                               trade, i.e. a BUY (SELL) trade.
%
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

%% Data Preparation - Message File
% Remove observations outside the official trading hours
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Trading hours (start & end)
startTrad   = 9.5*60*60;       % 9:30:00 in sec
% after midnight
endTrad     = 16*60*60;        % 16:00:00 in sec
% after midnight
% Get index of observations
timeIdx = mess(:,1) >= startTrad & mess(:,1) <= endTrad;
mess = mess(timeIdx,:);
% Note: As the rows of the message and orderbook file
%       correspond to each other, the time index of
%       the message file can also be used to 'cut'
%       the orderbook file.

% Check for trading halts
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
tradeHaltIdx = find(mess(:,2) == 7);
if ~isempty(tradeHaltIdx)
    disp(['Data contains trading halt! Trading halt, ' ...
        'quoting resume, and resume of trading indices in tradeHaltIdx']);
else
    disp('No trading halts detected.');
end
%       When trading is halted, a message of type '7' is written into the
% 		message file. The corresponding price and trade direction are set
% 		to '-1' and all other properties are set to '0'.
% 		Should quoting be allowed during the halt, another message
% 		of type '7' with price '0' is added. Again the trade direction
% 		is set to '-1' and all other fields are set to '0'.
% 		The resuming of trading is indicated by a message of type '7'
% 		and price '1' (Trade direction '-1' and all other entries '0').
% 		For messages of type '7' the corresponding orderbook rows contains
% 		a duplication of the preceding order book state.
% 		The reason for the trading halt is not included in the output.
%
% 			Example: Stylized trading halt messages in 'message' file.
%
% 			Halt: 				36023	| 7 | 0 | 0 | -1 | -1
% 											...
% 			Quoting: 			36323 	| 7 | 0 | 0 | 0  | -1
% 											...
% 			Resume Trading:		36723   | 7 | 0 | 0 | 1  | -1
% 											...
% 			The vertical bars indicate the different columns in the
% 			message file.

%% Set Bounds for Intraday Intervals
% Define interval length
freq = 5*60;   % Interval length in sec
% Set interval bounds
bounds = (startTrad:freq:endTrad)';
% Number of intervals
bl = size(bounds,1);
% Indices for intervals
boundIdx = zeros(bl,1);
k1 = 1;
for k2 = 1:size(mess,1)
    if mess(k2,1) >= bounds(k1)
        boundIdx(k1,1) = k2;
        k1 = k1+1;
    end
end
% Get index of observations relevant for the bound
boundIdx(1:end-1) = boundIdx(1:end-1)-1;
boundIdx(end) = length(mess);
% Note:
%   -   This is a rather rough procedure for obtaining
%       interval bounds! Be careful!
%   -   boundIdx(1) = 0 due to loop characteristics below.

%% Sampling - Number of Executions and Trade Volume by Interval
% Note: Difference between trades and executions
%
%       The LOBSTER output records limit order executions
%       and not what one might intuitively consider trades.
%
%       Imagine a volume of 1000 is posted at the best ask
%       price. Further, an incoming market buy order of
%       volume 1000 is executed against the quote.
%
%       The LOBSTER output of this trade depends on the
%       composition of the volume at the best ask price.
%       Take the following two scenarios with the best ask
%       volume consisting of ...
%       (a) 1 sell limit order with volume 1000
%       (b) 5 sell limit orders with volume 200 each
%           (ordered according to time of submission)
%
%       The LOBSTER output for case ...
%       (a) shows one execution of volume 1000. If the
%           incoming market order is matched with one
%           standing limit order, execution and trade
%           coincide.
%       (b) shows 5 executions of volume 200 each with the
%           same time stamp. The incoming order is matched
%           with 5 standing limit orders and triggers 5
%           executions.
%
%       Bottom line:
%       LOBSTER records the exact limit orders against
%       which incoming market orders are executed. What
%       might be called 'economic' trade size has to be
%       inferred from the executions.


% Collection matrix
tradesInfo = zeros(bl-1,4);
% Note: Number visible executions, volume visible
%       trades, number hidden executions,
%       volume hidden trades
for k1 = 1:(bl-1)
  
    % Get intraday mess window
    temp	= mess(boundIdx(k1)+1:boundIdx(k1+1),[2,4]);
    % Visible
    tempVis = temp(temp(:,1)==4,2);
    % Hidden
    tempHid = temp(temp(:,1)==5,2);
    % Collect information
    tradesInfo(k1,:) = [ size(tempVis,1), sum(tempVis), ...
        size(tempHid,1), sum(tempHid)];
    clear temp tempVis tempHid;
end

%% Plot - Number of Executions and Trade Volume by Interval
% Plot number of executions
figure('color','white','Name','Number of Executions');
% Visible ...
bar(tradesInfo(:,1),'red');
title({[ticker ' // ' ...
    datestr(datenum(demoDate),'yyyy-mmm-dd')] ...
    ['Number of Executions per ' ...
    num2str(freq./60) ' min Interval ']});
xlabel('Interval');
ylabel(['Number of Executions']);
hold on
% Hidden ...
bar(-tradesInfo(:,3),'blue');
% Legend
legend('Visible','Hidden','Location','North');
hold off;

% Plot volume of trades
figure('color','white','Name','Volume of Trades');
% Visible ...
bar(tradesInfo(:,2)./100,'red');
title({[ticker ' // ' ...
    datestr(datenum(demoDate),'yyyy-mmm-dd')] ...
    ['Volume of Trades per ' ...
    num2str(freq./60) ' min Interval ']});
xlabel('Interval');
ylabel(['Volume of Trades (x100 Shares)']);
hold on
% Hidden ...
bar(-tradesInfo(:,4)./100,'blue');
% Legend
legend('Visible','Hidden','Location','North');
hold off;
% Note: When considering cumulative volume in an interval
%       the distinction between trades and executions is
%       not necessary. However, when, for example,
%       investigating average trade size one can not rely
%       on the computations performed here. In this case
%       the executions first have to be aggregated to
%       trades.

%% Load Orderbook File
% Load data
book = dlmread(nameBook);
% Note: The file contains more than 250 000 entries. It
%       takes a few seconds to load.

% Orderbook file information:
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
%
%   - Dimension:    (NumberEvents x (NumberLevels*4+1))
%
%   - Structure:    Each row:
%                   Ask price 1, Ask volume 1, Bid price 1,
%                   Bid volume 1, Ask price 2, Ask volume 2,
%                   Bid price 2, Bid volume 2, ...
%
%   - Note:         Unoccupied bid (ask) price levels are
%                   set to -999999999 (99999999) with volume 0
%
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH


%% Data Preparation - Orderbook File

% Remove observations outside the official trading hours
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Remove observations outside time window
book = book(timeIdx,:);
% Convert prices into dollars
% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
book(:,[1:2:(4*lvl)]) = book(:,[1:2:(4*lvl)])./10000;
% Note: LOBSTER stores prices in dollar price times 10000

%% Plot - Snapshot of the Limit Order Book
% Select index of event to be displayed
eventIdx = unidrnd(length(book));
% Note: Pick a random row/event from the order book

% Postions of variables in the book
askPricePos = 1:4:(lvl*4);
askVolPos   = askPricePos+1;
bidPricePos = askPricePos+2;
bidVolPos   = bidPricePos+1;
vol         = 2:2:(lvl*4);

% Plot limits ...
% Price
maxPrice =  book(eventIdx,askPricePos(lvl)) + 0.01;
minPrice =  book(eventIdx,bidPricePos(lvl)) - 0.01;

% Volume
maxVol =  max(book(eventIdx,vol));

% Mid quote
mid = 0.5*(sum(book(eventIdx,[1,3]),2));

% Plot
figure('color','white','Name','Limit Order Book - Snapshot');
% Ask side
barh(book(eventIdx,askPricePos)', ...
    book(eventIdx,askVolPos)','green');
title({[ticker ' // ' ...
    datestr(datenum(demoDate),'yyyy-mmm-dd')] ...
    [' LOB Snapshot - Time: ' ...
    num2str(mess(eventIdx,1)) ' sec']});
xlabel('Volume');
ylabel('Price ($)');
ylim([minPrice,maxPrice]);
xlim([0,maxVol]);
hold on;
% Bid side
barh(book(eventIdx,bidPricePos)', ...
    book(eventIdx,bidVolPos)','red');
% Mid
plot(50,mid,'<k','LineWidth', 2);
% Legend
legend('Ask','Bid','Mid','Location','East');
hold off


%% Plot - Relative Depth in the Limit Order Book
% Relative volume ...
% Ask
bookVolAsk = cumsum(book(eventIdx,askVolPos),2);
bookVolAsk = bookVolAsk./bookVolAsk(end);

% Bid
bookVolBid = cumsum(book(eventIdx,bidVolPos),2);
bookVolBid = bookVolBid./bookVolBid(end);

% Plot
figure('color','white','Name',...
    'Limit Order Book - Relative Depth');
% Ask side
stairs((1:lvl)',bookVolAsk','LineWidth',1.5,'Color','g');
title({[ticker ' // ' ...
    datestr(datenum(demoDate),'yyyy-mmm-dd')] ...
    ['LOB Relative Depth - Time: ' ...
    num2str(mess(eventIdx,1)) ' sec']});
ylabel('% of Volume');
xlabel('Level');
xlim([0,lvl]);
set(gca,'YTickLabel', ...
    {'1','0,8','0.6','0,4','0,2','','0,2', ...
    '0,4','0,6','0,8','1'},'YTick', ...
    [-1 -0.8 -0.6 -0.4 -0.2 0 0.2 0.4 0.6 0.8 1]);
hold on

% Bid side
stairs((1:lvl)',-1*bookVolBid', ...
    'LineWidth',1.5,'Color','r');

% Legend
legend('Ask','Bid','Location','SouthWest');

hold off

%% Plot bid/ask spread intraday evolution
plot(mess(:,1)./(60*60), ...
    book(:,[1,3]));
title({[ticker ' // ' ...
    datestr(datenum(demoDate),'yyyy-mmm-dd')] ...
    ['Intraday Evolution of Bid/Ask spread']});
axis tight;

%% Plot - Intraday Evolution of Depth

% Display only the first 3 levels
maxLvl = 3;
% Postion of volumes in the book
askVolPos = 2:4:maxLvl*4;
% Depth
bookVolAsk  = cumsum(book(:,askVolPos)./100,2);
bookVolBid  = cumsum(book(:,askVolPos+2)./100,2);
% Max depth
maxVol = max(max(bookVolAsk(:,end)),max(bookVolBid(:,end)));
maxVol = floor(maxVol*1.1/10)*10;
% LegendStr
legendStr = [repmat('Ask',maxLvl,1),blanks(maxLvl)',...
    num2str((1:maxLvl)'); repmat('Bid',maxLvl,1), ...
    blanks(maxLvl)',num2str((1:maxLvl)')];
% Plot
figure('color','white','Name', ...
    'Limit Order Book - Intraday Depth');
plot(mess(:,1)./(60*60), ...
    [bookVolAsk, -1*bookVolBid]);
title({[ticker ' // ' ...
    datestr(datenum(demoDate),'yyyy-mmm-dd')] ...
    ['Intraday Evolution of Depth']});
ylim([-maxVol,maxVol]);
xlim([9,16.5]);
xlabel('Time');
ylabel(['Bid ' blanks(12) ...
    ' Number of Shares (x100) ' blanks(12) ' Ask ']);
% Tick labels
set(gca,'YTickLabel',{' ', num2str(maxVol/2), 0, ...
    num2str(maxVol/2), ' '},'YTick', ...
    [-maxVol -maxVol/2 0 maxVol/2 maxVol]);
% Legend
legend(legendStr,'Location','SouthOutside', ...
    'Orientation', 'horizontal');

%% Preprocessing our VAR time serie
% execution business times
execution_id = (mess(:,2) == 4) | (mess(:,2)==5);
% locating buyer initiated trade (execution of a sell limit order)
all_buy_exec=execution_id&mess(:,6)==-1;
all_buy_exec=double(all_buy_exec);
buy_initiated=all_buy_exec;
buy_initiated(2:end)=all_buy_exec(2:end)-all_buy_exec(1:end-1);
buy_initiated=max(buy_initiated,0);
% locating seller initiated trade  (execution of a buy limit order)
all_sell_exec=execution_id&mess(:,6) ==1;
all_sell_exec=double(all_sell_exec);
sell_initiated=all_sell_exec;
sell_initiated(2:end)=all_sell_exec(2:end)-all_sell_exec(1:end-1);
sell_initiated=max(sell_initiated,0);
% consecutive executions of sell limit order stem from a same market order
% executing over multiple limit orders

%% Concatenating relevant values
% Display only the first 3 levels
maxLvl = 3;
% Postion of ask volumes in the book for the first 3 levels
askVolPos = 2:4:maxLvl*4;
% log best ask, log best bid, log best ask volume, log best bid volume,
Y=[log(book(:,1)),log(book(:,3)), log(book(:,askVolPos)),log(book(:,askVolPos+2)),buy_initiated,sell_initiated];
timestamps=mess(:,1);

%% Saving as a .mat file
save('preprocessed_time_series.mat','Y','timestamps');





##### SOURCE END #####
--></body></html>